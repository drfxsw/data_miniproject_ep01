{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 4-2-3 bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <!-- 4-2-2 -->
    <link rel="stylesheet" href="{% static 'styles/main.css' %}">
    <!-- 4-2-4 -->
    <link rel="stylesheet" href="{% static 'styles/pages/hypothesis.css' %}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>생활습관 및 건강지표와 폐암사망률</title>
</head>
<body>
    <header>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="fw-bold">생활습관 및 건강지표와 폐암사망률 분석</h2>
                </div>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="hypothesis-section" id="hypothesisSection">
            <ul>
                {% for hypothesis in hypothesis_data %}
                <li {% if forloop.first %}class="active"{% endif %}>
                    <a href="javascript:void(0)" 
                       class="hypothesis-link {% if forloop.first %}active{% endif %}" 
                       data-target="hypo-{{ forloop.counter }}">
                        {{ hypothesis.title }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- 가설별 캐러셀 -->
        <div class="carousel">
            <!-- 5-2-1, 5-2-2 -->
            {% for hypothesis in hypothesis_data %}
            <div id="hypo-{{ forloop.counter }}" 
                 class="hypothesis-card card p-4 mb-4 shadow-sm {% if forloop.first %}active{% endif %}">
                <h5 class="mb-3">
                    <i class="fas fa-microscope me-2"></i>
                    {{ hypothesis.title }}
                </h5>
                {% if hypothesis.hypothesis %}
                    <div class="mb-2">
                        <p>귀무가설(H0): {{ hypothesis.hypothesis.h0 }}</p>
                        <p>대립가설(H1): {{ hypothesis.hypothesis.h1 }}</p>
                    </div>
                {% endif %}
                <!-- 차트 이미지들 -->
                <div class="chart-images row">
                    {% if hypothesis.images %}
                        {% for chart in hypothesis.images %}
                        <div class="chart-item col-lg-4 col-md-6">
                            <div class="chart-image-container">
                                <img src="{% static chart.path %}" 
                                     alt="{{ chart.filename }}" 
                                     class="chart-image img-fluid rounded"
                                     loading="lazy">
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <!-- 차트 이미지 없을경우 대체 -->
                        <div class="no-images text-center text-muted col-12">
                            <i class="fas fa-image fa-3x mb-3"></i>
                            <p>해당 가설에 대한 차트 이미지가 없습니다.</p>
                            <small>경로: {{ hypothesis.folder_path }}</small>
                        </div>
                    {% endif %}
                </div>

                <!-- 5-2-1, 5-2-2 -->
                <!-- 분석 결과 -->
                {% if hypothesis.results %}
                <div class="hypothesis-results">
                    <h6 class="mb-3">
                        <i class="fas fa-chart-bar me-2"></i>
                        분석 결과
                    </h6>
                    <div class="descriptions">
                        <ul>
                            {% for key, value in hypothesis.results.items %}
                                <li class="pb-1"><strong>{{ key|capfirst }}:</strong> {{ value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% if hypothesis.conclusion %}
                    <p class="result text-dark">
                        <i class="fas fa-check-circle me-2"></i>
                        {{ hypothesis.conclusion }}
                    </p>
                    {% endif %}
                    {% if hypothesis.result %}
                    <hr>
                    <p class="mt-2">
                        {{ hypothesis.result }}
                    </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const hypothesisSection = document.getElementById('hypothesisSection');
    const hypothesisLinks = document.querySelectorAll('.hypothesis-link');
    const hypothesisCards = document.querySelectorAll('.hypothesis-card');
    const dropdownList = hypothesisSection.querySelector('ul');
    
    // 원본 데이터 저장 (초기 로드시)
    const originalItems = [];
    hypothesisLinks.forEach((link, index) => {
        originalItems.push({
            text: link.textContent.trim(),
            target: link.getAttribute('data-target'),
            isFirst: index === 0
        });
    });
    
    let currentSelectedIndex = 0; // 현재 선택된 항목의 인덱스

    // 첫 번째 가설을 기본으로 표시
    showHypothesis('hypo-1');

    // 첫 번째 항목 클릭시 드롭다운 토글
    const firstLink = hypothesisLinks[0];
    firstLink.addEventListener('click', function(e) {
        e.preventDefault();
        hypothesisSection.classList.toggle('open');
    });

    // 각 링크에 클릭 이벤트 추가 (첫 번째 제외)
    hypothesisLinks.forEach((link, index) => {
        if (index === 0) return; // 첫 번째는 토글용이므로 제외

        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('data-target');
            const selectedText = this.textContent.trim();
            
            // 선택된 항목의 인덱스 찾기
            const selectedIndex = originalItems.findIndex(item => 
                item.text === selectedText && item.target === targetId
            );
            
            if (selectedIndex !== -1) {
                currentSelectedIndex = selectedIndex;
                updateDropdownDisplay();
                
                // 드롭다운 닫기
                hypothesisSection.classList.remove('open');
                
                // 해당 가설 카드 표시
                showHypothesis(targetId);
            }
        });
    });

    // 외부 클릭시 드롭다운 닫기
    document.addEventListener('click', function(e) {
        if (!hypothesisSection.contains(e.target)) {
            hypothesisSection.classList.remove('open');
        }
    });

    function updateDropdownDisplay() {
        // 선택된 항목을 첫 번째 위치에 표시
        const selectedItem = originalItems[currentSelectedIndex];
        firstLink.textContent = selectedItem.text;
        firstLink.setAttribute('data-target', selectedItem.target);
        
        // 드롭다운 목록 재구성 (선택된 항목 제외하고 모든 항목 표시)
        const listItems = dropdownList.querySelectorAll('li');
        
        // 첫 번째 li는 유지하고, 나머지는 새로 구성
        for (let i = listItems.length - 1; i > 0; i--) {
            listItems[i].remove();
        }
        
        // 선택되지 않은 모든 항목을 드롭다운에 추가
        originalItems.forEach((item, index) => {
            if (index !== currentSelectedIndex) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                
                a.href = 'javascript:void(0)';
                a.className = 'hypothesis-link';
                a.setAttribute('data-target', item.target);
                a.textContent = item.text;
                
                // 클릭 이벤트 추가
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetId = this.getAttribute('data-target');
                    const selectedText = this.textContent.trim();
                    
                    // 새로 선택된 항목의 인덱스 찾기
                    const newSelectedIndex = originalItems.findIndex(item => 
                        item.text === selectedText && item.target === targetId
                    );
                    
                    if (newSelectedIndex !== -1) {
                        currentSelectedIndex = newSelectedIndex;
                        updateDropdownDisplay();
                        
                        // 드롭다운 닫기
                        hypothesisSection.classList.remove('open');
                        
                        // 해당 가설 카드 표시
                        showHypothesis(targetId);
                    }
                });
                
                li.appendChild(a);
                dropdownList.appendChild(li);
            }
        });
        
        // active 상태 업데이트
        document.querySelectorAll('.hypothesis-link').forEach(link => {
            link.classList.remove('active');
            if (link.parentElement) {
                link.parentElement.classList.remove('active');
            }
        });
        
        firstLink.classList.add('active');
        firstLink.parentElement.classList.add('active');
    }

    function showHypothesis(targetId) {
        // 모든 카드에서 active 클래스 제거
        hypothesisCards.forEach(card => {
            card.classList.remove('active');
        });

        // 대상 카드에 active 클래스 추가
        const targetCard = document.getElementById(targetId);
        if (targetCard) {
            targetCard.classList.add('active');
        }
    }
});
</script>
</body>
</html>